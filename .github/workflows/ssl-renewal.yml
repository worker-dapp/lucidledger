name: SSL Certificate Renewal

on:
  schedule:
    - cron: '0 2 * * 1'  # Run weekly on Monday at 2 AM
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  actions: read

env:
  DOMAIN: lucidledger.co

jobs:
  renew-ssl:
    name: Renew SSL Certificates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
      timeout-minutes: 10
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add EC2 to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
    - name: Renew SSL Certificates
      run: |
        # Create SSL renewal script
        cat > renew-ssl.sh << 'EOF'
        #!/bin/bash
        set -e
        
        DOMAIN="${DOMAIN:-lucidledger.co}"
        
        echo "üîê Starting SSL certificate renewal..."
        echo "Domain: $DOMAIN"
        
        # Find project directory
        PROJECT_DIR=""
        if [ -d "/home/ec2-user/lucidledger" ]; then
          PROJECT_DIR="/home/ec2-user/lucidledger"
        elif [ -d "/home/ubuntu/lucidledger" ]; then
          PROJECT_DIR="/home/ubuntu/lucidledger"
        else
          echo "‚ùå Project directory not found. Searching for lucidledger directory..."
          PROJECT_DIR=$(find /home -type d -name "lucidledger" 2>/dev/null | head -1)
          if [ -z "$PROJECT_DIR" ]; then
            echo "‚ùå Could not find lucidledger directory"
            exit 1
          fi
        fi
        
        echo "üìÅ Using project directory: $PROJECT_DIR"
        cd "$PROJECT_DIR" || exit 1
        
        # Check if certificates need renewal
        CERT_PATH="ssl/live/$DOMAIN/fullchain.pem"
        if [ -f "$CERT_PATH" ]; then
          echo "üìÖ Checking certificate expiration..."
          
          # Get expiration date
          EXPIRY=$(openssl x509 -enddate -noout -in "$CERT_PATH" | cut -d= -f2)
          EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s 2>/dev/null || date -j -f "%b %d %H:%M:%S %Y %Z" "$EXPIRY" +%s 2>/dev/null || echo "0")
          CURRENT_EPOCH=$(date +%s)
          
          # Ensure certbot-webroot directory exists
          mkdir -p certbot-webroot
          
          if [ "$EXPIRY_EPOCH" != "0" ]; then
            if [ "$EXPIRY_EPOCH" -gt "$CURRENT_EPOCH" ]; then
              # Certificate is still valid
              DAYS_LEFT=$(( (EXPIRY_EPOCH - CURRENT_EPOCH) / 86400 ))
              echo "Certificate expires in $DAYS_LEFT days"
              
              if [ $DAYS_LEFT -lt 30 ]; then
                echo "‚ö†Ô∏è  Certificate expires soon, renewing..."
                RENEW_NEEDED=true
              else
                echo "‚úÖ Certificates are still valid for $DAYS_LEFT days"
                RENEW_NEEDED=false
              fi
            else
              # Certificate has expired
              DAYS_EXPIRED=$(( (CURRENT_EPOCH - EXPIRY_EPOCH) / 86400 ))
              echo "‚ùå Certificate expired $DAYS_EXPIRED days ago - URGENT RENEWAL NEEDED!"
              RENEW_NEEDED=true
            fi
          else
            # Could not determine expiration - attempt renewal to be safe
            echo "‚ö†Ô∏è  Could not determine certificate expiration, attempting renewal..."
            RENEW_NEEDED=true
          fi
          
          if [ "$RENEW_NEEDED" = "true" ]; then
            # Renew certificates using webroot method
            # Use --force-renewal if certificate is expired
            if [ "$EXPIRY_EPOCH" != "0" ] && [ "$EXPIRY_EPOCH" -le "$CURRENT_EPOCH" ]; then
              echo "üîÑ Forcing certificate renewal (certificate expired)..."
              RENEW_CMD="docker-compose -f docker-compose.nginx.yml run --rm certbot renew --webroot --webroot-path=/var/www/html --force-renewal"
            else
              RENEW_CMD="docker-compose -f docker-compose.nginx.yml run --rm certbot renew --webroot --webroot-path=/var/www/html --quiet"
            fi
            
            if eval "$RENEW_CMD"; then
              echo "‚úÖ SSL certificates renewed successfully!"
              
              # Reload Nginx to use new certificates
              docker-compose -f docker-compose.nginx.yml restart nginx || docker exec nginx-proxy nginx -s reload
              echo "‚úÖ Nginx reloaded with new certificates"
            else
              echo "‚ùå Certificate renewal failed"
              echo "üí° Trying dry-run to diagnose issue..."
              docker-compose -f docker-compose.nginx.yml run --rm certbot renew --webroot --webroot-path=/var/www/html --dry-run || true
              exit 1
            fi
          fi
        else
          echo "‚ùå No SSL certificates found at $CERT_PATH"
          echo "üí° You may need to run initial certificate setup"
        fi
        
        echo "üîç Testing HTTPS connection..."
        # Test multiple endpoints to verify HTTPS is working
        HTTPS_WORKING=false
        
        # Test root endpoint
        if curl -f -s --max-time 10 "https://$DOMAIN" > /dev/null 2>&1; then
          echo "‚úÖ HTTPS root endpoint is working"
          HTTPS_WORKING=true
        fi
        
        # Test API health endpoint (more reliable)
        if curl -f -s --max-time 10 "https://$DOMAIN/api/health" > /dev/null 2>&1; then
          echo "‚úÖ HTTPS API endpoint is working"
          HTTPS_WORKING=true
        fi
        
        # Test via localhost (in case domain doesn't resolve from inside EC2)
        if curl -f -s --max-time 10 -k "https://localhost/api/health" > /dev/null 2>&1; then
          echo "‚úÖ HTTPS localhost endpoint is working"
          HTTPS_WORKING=true
        fi
        
        if [ "$HTTPS_WORKING" = "true" ]; then
          echo "‚úÖ HTTPS is working correctly"
        else
          echo "‚ö†Ô∏è  HTTPS test failed, but renewal may have succeeded"
          echo "üí° Check manually: curl -I https://$DOMAIN"
        fi
        
        echo "üéâ SSL renewal process completed!"
        EOF
        
        chmod +x renew-ssl.sh
        
        # Execute SSL renewal script on EC2 with DOMAIN environment variable
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "DOMAIN=${{ env.DOMAIN }} bash -s" < renew-ssl.sh
        
    - name: SSL Renewal Status
      run: |
        echo "üîê SSL certificate renewal completed!"
        echo "üåê Your app should continue working with valid HTTPS"
        echo "üìÖ Next renewal check: Next Monday at 2 AM UTC"

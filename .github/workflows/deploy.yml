name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (prod or staging)'
        required: true
        default: 'prod'
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
  push:
    branches: [ main ]

env:
  PROD_DOMAIN: lucidledger.co
  STAGING_DOMAIN: staging.lucidledger.co

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js (client)
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install frontend dependencies
      working-directory: ./client
      run: |
        npm config set cache .npm-cache
        npm install

    - name: Build frontend
      working-directory: ./client
      env:
        VITE_API_URL: https://lucidledger.co
        VITE_DYNAMIC_ENV_ID: ${{ secrets.VITE_DYNAMIC_ENV_ID }}
      run: npm run build

    - name: Setup Node.js (server)
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: Install backend dependencies
      working-directory: ./server
      run: |
        npm config set cache .npm-cache
        npm install
      
    - name: Run frontend tests
      working-directory: ./client
      run: npm run lint || echo "ESLint issues found, but continuing deployment"
      
    - name: Run backend tests
      working-directory: ./server
      run: npm run lint || echo "No lint script found, skipping"

  deploy:
    name: Deploy to EC2
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select target host/user
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.environment }}" = "staging" ]; then
          echo "TARGET_HOST=${{ secrets.STAGING_HOST }}" >> $GITHUB_ENV
          echo "TARGET_USER=${{ secrets.STAGING_USER }}" >> $GITHUB_ENV
          echo "TARGET_KEY<<EOF" >> $GITHUB_ENV
          echo "${{ secrets.STAGING_SSH_KEY }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        else
          echo "TARGET_HOST=${{ secrets.EC2_HOST }}" >> $GITHUB_ENV
          echo "TARGET_USER=${{ secrets.EC2_USER }}" >> $GITHUB_ENV
          echo "TARGET_KEY<<EOF" >> $GITHUB_ENV
          echo "${{ secrets.SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        fi

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ env.TARGET_KEY }}
        
    - name: Add EC2 to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H "$TARGET_HOST" >> ~/.ssh/known_hosts
        
    - name: Deploy to EC2
      run: |
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸš€ Starting deployment..."
        
        # Set domain and branch based on input
        if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
          DOMAIN="${{ env.STAGING_DOMAIN }}"
          BRANCH="${{ github.event.inputs.branch }}"
          [ -z "$BRANCH" ] && BRANCH=develop
          REPO_DIR="/home/ec2-user/lucidledger-staging"
        else
          DOMAIN="${{ env.PROD_DOMAIN }}"
          BRANCH="${{ github.event.inputs.branch }}"
          [ -z "$BRANCH" ] && BRANCH=main
          REPO_DIR="/home/ec2-user/lucidledger"
        fi

        # API domain used by the frontend
        API_DOMAIN="https://$DOMAIN"
        
        # Navigate to project directory
        cd "$REPO_DIR" || cd /home/ubuntu/$(basename "$REPO_DIR")
        
        # Pull latest changes
        echo "ðŸ“¥ Pulling latest changes..."
        git pull origin "$BRANCH"
        
        # Create environment files
        echo "ðŸ“ Creating environment files..."
        
        # Backend environment
        cat > server/.env << EOL
# Database Configuration
DB_HOST=${{ secrets.DB_HOST }}
DB_PORT=${{ secrets.DB_PORT }}
DB_NAME=${{ secrets.DB_NAME }}
DB_USER=${{ secrets.DB_USER }}
DB_PASSWORD=${{ secrets.DB_PASSWORD }}

# Server Configuration
PORT=5001
NODE_ENV=production

# CORS Configuration
CORS_ORIGIN=https://$DOMAIN
EOL
        
        # Frontend environment
        cat > client/.env << EOL
# Dynamic Labs Configuration
VITE_DYNAMIC_ENV_ID=${{ secrets.VITE_DYNAMIC_ENV_ID }}

# API Configuration
VITE_API_BASE_URL=$API_DOMAIN/api

# Environment
NODE_ENV=production
EOL
        
        # Stop existing services
        echo "ðŸ›‘ Stopping existing services..."
        docker-compose -f docker-compose.nginx.yml down || true
        
        # Rebuild and start services
        echo "ðŸ”¨ Rebuilding and starting services..."
        docker-compose -f docker-compose.nginx.yml up -d --build
        
        # Wait for services to be ready
        echo "â³ Waiting for services to be ready..."
        sleep 60
        
        # Check service status
        echo "ðŸ“Š Checking service status..."
        docker-compose -f docker-compose.nginx.yml ps
        
        echo "ðŸŽ‰ Deployment completed successfully!"
        EOF
        
        chmod +x deploy.sh
        
        # Execute deployment script on EC2
        ssh -o StrictHostKeyChecking=no "$TARGET_USER"@"$TARGET_HOST" 'bash -s' < deploy.sh
        
    - name: Deployment Status
      run: |
        echo "ðŸŽ¯ Deployment completed!"
        if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
          echo "ðŸŒ Staging at: https://${{ env.STAGING_DOMAIN }}"
        else
          echo "ðŸŒ Production at: https://${{ env.PROD_DOMAIN }}"
        fi
        echo "ðŸ“± Check the deployment status above for any errors"
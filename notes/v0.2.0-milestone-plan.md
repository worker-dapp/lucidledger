# v0.2.0 Milestone Plan
**Status:** In Progress
**Last Updated:** 2026-02-20

---

## Overview

11 issues across the v0.2.0 milestone. The two large items — Compliance Hub (#52) and QR oracle (#54) — are saved for last. Everything before them is either a quick bug fix, a security patch, or a well-scoped enhancement.

---

## Phase 1: Quick Bug Fixes ✅ DONE (PR #67)

### #58 — Nginx $server_name → $host ✅
Changed `$server_name` to `$host` in the HTTP → HTTPS redirect in `nginx.conf`.

### #56 — Admin redirect bug ✅
Short-circuit `checkProfileAndRedirect` in `App.jsx` for admin users via `VITE_ADMIN_EMAILS` check before profile lookup.

### #41 — Email UNIQUE constraint ✅
Migration 018: dropped `UNIQUE` on `email`, added `UNIQUE` on `wallet_address` in both `employee` and `employer` tables. Updated Sequelize models to match. Also created issue #66 (v0.4.0) to store Privy DID and simplify the profile lookup chain.

### Deploy concurrency ✅
Added `concurrency` group per `github.ref` with `cancel-in-progress: true` to `deploy.yml`.

---

## Phase 2: Security & Data Integrity (~3–5 hrs total) (DONE)

Security issues should be resolved before opening up the platform further.

---

### #40 — Employer approval gating across API and paymaster
**Labels:** `backend`, `security`
**Effort:** ~2–3 hrs

Unapproved employers can currently interact with sponsored transaction infrastructure after logging in.

**Tasks:**
1. Create reusable `requireApprovedEmployer` middleware in `server/middleware/authMiddleware.js`:
   ```javascript
   exports.requireApprovedEmployer = async (req, res, next) => {
     // Look up employer by wallet address from req
     // Check approval_status === 'approved'
     // 403 if not approved
   };
   ```
2. Audit and apply to routes that need it:
   - `deployedContractController` — all write routes
   - `jobApplicationController` — accept/reject routes
   - `jobPostingController` — create/update routes
3. Add a frontend guard: show a "pending approval" banner on employer-facing pages if `approval_status !== 'approved'`.
4. **Testnet:** Frontend guard is sufficient. **Mainnet:** backend transaction proxy (Option A from issue) required to fully block paymaster abuse.

---

### #47 — Security hardening: admin endpoints, validation, audit logging
**Labels:** `backend`, `security`
**Effort:** Pick-off approach — do quick items now, defer heavy items

**Do now (quick items):**
- [x] Wallet address checksum validation via `ethers.getAddress()` at API boundaries — **input hygiene only** (rejects malformed addresses, normalizes to EIP-55). Does not close the identity spoofing gap; see #71 for the full fix.
- [x] Stricter rate limiting on admin endpoints (20 req/15min on `/api/admin/*`)
- [x] Immutable fields protection in `updateDeployedContract` (block changing `contract_address`, `employer_id`, `employee_id`, `job_posting_id`, `payment_amount`)
- [x] Dedicated `GET /api/admin/check` endpoint

**Defer to after Compliance Hub (#52):**
- On-chain event verification via factory events (prevents client-reported address fraud) — this is the most impactful item but also the most complex; coordinate with QR oracle work
- Audit logging — being built as part of #52
- Two-factor for admin actions — post-v0.2

**Tracked separately (v0.3.0):**
- #71 — Server-side wallet identity binding via Privy DID: `x-wallet-address` is client-controlled and cannot be trusted for authorization. Full fix requires #66 (Privy DID column, moved to v0.3.0): resolve wallet server-side from DB via `privy_did`, set `req.authenticatedWalletAddress`, deprecate header as auth input.

---

## Phase 3: Feature Enhancements (~10–14 hrs total)

Well-scoped, additive features with clear acceptance criteria.

### #26 — Contract terms snapshot (immutable signing record)
**Labels:** `enhancement`, `backend`, `frontend`
**Effort:** ~4–5 hrs

Workers should be able to view the exact terms they signed. Currently the UI uses the live job posting, which can change.

**Tasks:**
1. ✅ Add `contract_snapshot JSONB` column to `deployed_contracts` table.
   - **Migration:** `server/migrations/019-add-contract-snapshot.sql`
2. ✅ Populate snapshot at contract deployment time from `job_postings` record.
   - Captures: job title, pay rate, location, job type, responsibilities, benefits, additional compensation, oracles, deadline, company name.
3. ✅ Backend: `contract_snapshot` included automatically in `GET /api/deployed-contracts/:id` response via Sequelize.
4. ✅ Frontend: render "Terms at Signing" section in Job Tracker contract detail view (read-only, "Verified snapshot" / "Live posting data" badge).
5. ✅ Handle nulls gracefully — legacy contracts fall back to live job posting data with amber warning note.
6. ✅ Move snapshot capture to **signing time** (not deployment time):
   - Added `contract_snapshot JSONB` to `job_applications` table (migration 020).
   - Populated in `jobApplicationController.updateApplicationStatus` when `status === 'signed'`.
   - `createDeployedContract` copies snapshot from `job_applications` instead of re-fetching the job posting.
7. ✅ Bind payment amount to worker's EIP-712 signature (Option A — off-chain binding):
   - Added `paymentAmount` and `jobTitle` to the `OfferAcceptance` typed data struct in `EmployeeJobsPage.jsx`.
   - Server-side signature verification deferred — EOA vs smart wallet address mismatch in Privy AA model; tracked in v0.4.0 issue #89.
8. ✅ Soft-delete job postings (sets `status = 'deleted'`, preserves deployed contracts and FK links).
   - Replaced Close + Delete buttons with a single X button in PostedJobsTab.
   - Removed "Edit functionality coming soon" button.
   - Backend excludes `deleted` postings from employer queries by default.

---

### #50 — Worker profile buildout: tiered fields + completeness indicator
**Labels:** `enhancement`, `backend`, `frontend`
**Effort:** ~4–6 hrs

Expand the worker profile with a tiered approach. Tier 1 (required at onboarding), Tier 2 (prompted, optional), Tier 3 (fully optional).

**Tasks:**
1. **DB migration:** Add `primary_language VARCHAR(50)`, `availability VARCHAR(50)`, `bio TEXT`, `willing_to_travel BOOLEAN` to `employee` table.
   - **Migration:** `017-employee-profile-fields.sql` (check if this overlaps with migration 014)
2. **Simplify onboarding (`UserProfile`):** Move street address to optional (Tier 3). Require: first name, last name, city, country, primary language.
3. **Profile completeness indicator:**
   - Calculate score from filled Tier 1 + Tier 2 fields.
   - Show progress bar on `EmployeeProfile` page.
   - Optionally surface score to employers on application review.
4. **Update `EmployeeProfile` page:** Add Tier 2 fields in an "Enhance your profile" section (bio, availability, willing to travel, skills, work experience already exist).

---

### #51 — Worker earnings view improvements
**Labels:** `enhancement`, `frontend`
**Effort:** ~2–3 hrs

The earnings tab in Job Tracker shows totals and a transaction list. No new routes needed unless scope grows.

**Tasks:**
1. Surface USDC wallet balance (read from chain via `publicClient.readContract` on the USDC token).
2. Add date range filter (start/end date inputs) to the transaction list.
3. Group transactions by employer or time period (weekly/monthly toggle).
4. Keep on the existing Job Tracker tab — only split to `/earnings` if the component grows unwieldy.

---

## Phase 4: API Request Deduplication (~4–8 hrs, scope first)

### #22 — Fix duplicate API requests causing rate limiting
**Labels:** `bug`, `backend`, `frontend`
**Effort:** 4–8 hrs depending on approach

Currently 20–30 API requests per page load instead of ~5. Root causes: React Strict Mode doubling `useEffect` calls, components fetching the same data independently, bad dependency arrays.

**Approach decision (pick one before coding):**
- **Option A (Library):** Add React Query or SWR. Handles deduplication, caching, and stale-while-revalidate automatically. Higher upfront investment but cleaner long-term.
- **Option B (Manual):** Fix `useEffect` dependency arrays, consolidate fetching to parent components, add a simple in-memory cache. Lower investment but requires discipline going forward.

**Recommendation:** Scope the per-page request counts first using browser DevTools Network tab before choosing. If there are 5+ components independently fetching the same endpoint, React Query is worth it. If it's mostly bad dep arrays, fix manually.

**If going manual:**
- Audit `useEffect` calls across `JobTracker`, `WorkforceDashboard`, `ContractFactory`, `EmployeeJobsPage`.
- Rate limiting is re-enabled in production; fix is needed before production launch.

---

## Phase 5: Compliance Hub (~10–13 hrs)

### #52 — Build Compliance Hub: tabbed UI, audit logging, report exports
**Labels:** `enhancement`, `backend`, `frontend`
**Effort:** 10–13 hrs across 2–3 sessions
**Detail:** See `notes/todo-compliance-hub-buildout.md` for full implementation plan.

**Summary of phases:**
1. **Phase 1:** Consolidate `/dispute` + `ReviewCompletedContracts` into `/compliance` with tabbed UI.
2. **Phase 2:** `audit_log` table (migration 015 or next available), `logAction()` helper, integrate into 5+ controllers.
3. **Phase 3:** CSV export endpoints (workforce summary, payment history, oracle verifications) + Reports tab.

**Dependencies from earlier phases:**
- #47's audit logging items are subsumed here.
- The `requireApprovedEmployer` middleware from #40 should be applied to compliance read endpoints too.

---

## Phase 6: QR Oracle (~15–20 hrs)

### #54 — QR code time clock oracle: scan-based worker clock-in/clock-out
**Labels:** `enhancement`, `backend`, `frontend`, `infrastructure`
**Effort:** 15–20 hrs (most infrastructure-heavy item in v0.2)

**Architecture summary:**
- Worker: "Show QR" screen generates a short-lived opaque token.
- Kiosk: Camera page scans QR, POSTs to presence-event endpoint.
- Backend: validates token, records presence event in DB, server wallet calls `QRCodeOracle.verify()` on-chain.
- Offline: kiosk stores events in IndexedDB, syncs when network returns.
- On-chain anchoring: batch hash written periodically (not per-event).

**Implementation sequence (MVP):**
1. `POST /api/qr-token` — generate short-lived token (15–30 sec TTL), store in Redis or DB with contractAddress + workerId.
2. `POST /api/presence-event` — validate token, record event, call oracle.
3. Worker UI: "Show QR" button on Job Tracker for active contracts.
4. Kiosk UI: `/kiosk` page (employer-facing), camera access via `jsQR` library, online/offline queue.
5. Server wallet: EOA funded with small ETH on Base for gas. Store private key in env var.
6. `QRCodeOracle.sol`: already in the oracle registry from #38. Wire up `verify(contractAddress)` call.
7. Shift rules: configurable clock-in window per contract (e.g., 15 min before shift start).
8. Batch anchoring: cron job writes Merkle root of presence events to chain periodically.

**Infrastructure notes (from `future-contract-roadmap.md`):**
- Server wallet is a regular EOA — not covered by Coinbase paymaster. Needs small ETH balance on Base.
- Pennies of ETH covers thousands of L2 transactions.
- Security: server wallet can call `verify()` but cannot release escrow — employer's `approveAndPay()` still required.

---

## Issue Order Summary

| # | Issue | Phase | Effort |
|---|-------|-------|--------|
| #58 | Nginx $server_name → $host | 1 ✅ | ~10 min |
| #56 | Admin redirect bug | 1 ✅ | ~30 min |
| #41 | Email UNIQUE constraint | 1 ✅ | ~1 hr |
| #40 | Employer approval gating | 2 | ~2–3 hrs |
| #47 | Security hardening (quick items) | 2 | ~2 hrs |
| #26 | Contract terms snapshot | 3 | ~3–4 hrs |
| #50 | Worker profile buildout | 3 | ~4–6 hrs |
| #51 | Worker earnings view | 3 | ~2–3 hrs |
| #22 | Duplicate API requests | 4 | ~4–8 hrs |
| #52 | Compliance Hub | 5 | ~10–13 hrs |
| #54 | QR oracle | 6 | ~15–20 hrs |

**Total estimated effort:** ~45–65 hrs

---

## Notes

- **Migration numbering:** Check what number is next. Migration 014 is `employee-profile-fields`. Next available is 015. The compliance hub audit log and email constraint drop may both need slots — assign carefully.
- **#38 status:** Modular oracle architecture was merged in PR #55. QR oracle (#54) builds on that foundation.
- **#47 on-chain event verification:** Deferred to v0.3 or coordinate with #54 QR oracle work — both involve server-side blockchain writes.
- **Rate limiting:** Re-enabled in production. #22 must be resolved before production launch.
